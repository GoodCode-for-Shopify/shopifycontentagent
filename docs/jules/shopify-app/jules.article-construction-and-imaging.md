# Content Agent Shopify App: Article Construction & Imaging

This document details the subsequent steps in the "Content Agent" Shopify app's article generation flow: AI Article Construction and AI Image Generation. These steps follow the "Article Outline Generation" and are applied to one article at a time, potentially selected from an "Article Editor/Generator Workspace" if multiple articles are being processed.

## Step 5: AI Article Construction

*   **Purpose:** Generate the full text of the blog article based on the user-approved outline, focusing on SEO, conversion optimization, and reader value.
*   **Context:** The user has selected an approved outline (from Step 4) to work on.
*   **UI (React/Polaris):**
    *   A dedicated "Article Construction" view or section.
    *   Display the selected outline (H1, H2s, H3s) for reference, perhaps in a sidebar.
    *   A main content area where the AI-generated article text will appear. This could be a rich text editor (e.g., using a library like Quill, Tiptap, or a simpler Polaris `TextField` with `multiline` if only plain text editing is needed post-generation, though rich text is better for final review).
    *   A "Generate Article" button.
    *   While generating, display a loading indicator (Polaris `Spinner` or `ProgressBar`).
*   **Backend Interaction (Cloud Function - e.g., `POST /api/content/construct-article`):**
    *   Receives: The approved article outline data structure (H1, H2s, H3s, associated keywords/questions, product context), `shop_id`.
    *   Logic:
        1.  Construct a detailed prompt for Gemini AI (or equivalent). The prompt should instruct the AI to:
            *   Write a blog article of 1800-2500 words.
            *   Strictly follow the provided outline (H1, H2s, H3s).
            *   Incorporate the selected keywords naturally for SEO.
            *   Address the selected "Related Questions" within the content.
            *   Focus on conversion optimization: include contextual links to the relevant Shopify product(s) and a clear call to action.
            *   Adhere to specified style guides: e.g., "no emdashes," professional yet engaging tone.
            *   **Crucially, include the watermark `[generated by Content Agent]` randomly within each paragraph.** This is a specific requirement.
        2.  Make the API call to the AI text generation service.
        3.  Receive the generated article text.
        4.  Return the full article text to the frontend.
*   **Frontend Display:**
    *   The returned article text is displayed in the main content area/editor.
    *   The user can then review this text. Minor edits might be allowed directly in the UI depending on the chosen editor.
    *   A button "Proceed to Image Generation" or "Skip Images & Review" would take them to the next applicable step.

## Step 6: AI Image Generation (Plan-Dependent & Optional)

*   **Purpose:** Generate relevant images for the article using AI, based on suggestions from the outline phase. This step is only available if enabled by the user's plan and if the user chooses to use it.
*   **Context:** The user has an AI-constructed article (from Step 5). The outline (Step 4) contained suggestions for where images would be appropriate and what they might depict.
*   **UI (React/Polaris):**
    *   A dedicated "Image Generation" view or section, possibly integrated with the article review.
    *   Display the article text (perhaps read-only or with minor edits still allowed).
    *   List the AI's image suggestions from the outline (e.g., "Section 2.1: Image of [product] being used by a happy customer").
    *   For each suggestion:
        *   A button like "Generate Image Options."
        *   An area to display 2-3 generated image options (thumbnails).
        *   Option for the user to select one image, or "Disregard this suggestion," or "Skip all image generation."
    *   If an image is selected, it should ideally be visually associated with the relevant section of the article text in the UI.
*   **Backend Interaction (Cloud Function - e.g., `POST /api/content/generate-image`):**
    *   Receives:
        *   An image suggestion/prompt (derived from the outline's image suggestion, possibly refined by AI or user).
        *   `shop_id`.
        *   Potentially some context from the article section for better image relevance.
    *   Logic:
        1.  Construct a detailed prompt for an AI image generation service (e.g., Imagen via Vertex AI, DALL-E API, Stable Diffusion API if self-hosted or via a provider).
        2.  Call the image generation API. This API will typically return image URLs (e.g., to images temporarily stored in Google Cloud Storage) or base64 encoded image data.
        3.  If returning URLs, ensure these are publicly accessible or that the frontend can access them.
        4.  Return the image URLs or data for the generated options (e.g., 2-3 variants per prompt) to the frontend.
*   **Frontend Handling:**
    *   Displays the generated image options.
    *   User selects an image. The selected image's URL (or a reference to it if stored by the backend) is associated with the article content.
    *   The user can proceed through all image suggestions or skip at any time.
*   **Storing Selected Images:**
    *   When an image is selected by the user for inclusion, its URL (if hosted by the AI service or temporarily by your app e.g. in Cloud Storage) needs to be saved along with the article data.
    *   For long-term use, especially if committing to Shopify blogs, these images might need to be uploaded to Shopify's CDN via the Shopify Admin API during the "Commit Content" step, or your application needs to ensure the image URLs remain stable. The latter is simpler if the AI service provides long-lived URLs. If not, your backend would need to download the image from the AI service and re-upload it to a persistent location (e.g., a Firebase Storage bucket associated with the tenant or app).

## Handling Multiple Articles

As noted in `docs/jules/shopify-app/jules.core-article-generation-flow.md`, if multiple article outlines were approved:
*   The user would select one article at a time from an "Article Editor/Generator Workspace."
*   They would then proceed through Step 5 (Article Construction) and Step 6 (Image Generation) for that single, selected article.
*   Upon completing these steps for one article (or explicitly deciding to save/commit it as is), they would return to the workspace to select the next article outline to process.

This modular approach (outline all, then construct/image one-by-one) prevents overwhelming the user and keeps each stage focused. The next step, "Commit Content," will then handle saving the finalized article(s) to Shopify or preparing them for export.
