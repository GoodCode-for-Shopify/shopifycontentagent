# Content Agent Shopify App: Article Construction & Imaging (Per-Article)

This document details the steps for AI-driven Article Construction and AI Image Generation within the "Content Agent" Shopify app. These processes are applied to a *single article* at a time, which the user has selected from the "Article Workspace" (or a similar dashboard/list view). The selected article already has a generated outline that is ready for review or has been approved.

This flow follows the batch outline generation detailed in `docs/jules/shopify-app/jules.core-article-generation-flow.md` and aligns with the overall multi-article management strategy outlined in `docs/jules/shopify-app/tech-design.multi-article-flow.md`.

## Starting Context: Processing a Single Article from the Workspace

The user is assumed to be in the "Article Workspace" where a list of articles (generated from a batch job, each with at least an outline) is displayed. The user selects one specific article from this list to proceed with the steps below. The `articleId` for this selected article is known and used in subsequent backend API calls.

## Step 5: AI Article Construction (for the Selected Article)

*   **Purpose:** Generate the full text of the selected blog article based on its existing outline, focusing on SEO, conversion optimization, and reader value.
*   **Context:** The user has selected a specific article (with its `articleId`) from the Article Workspace. This article has an outline ready.
*   **UI (React/Polaris - `SingleArticleProcessor` component):**
    *   A dedicated "Article Construction" view or section within the `SingleArticleProcessor`.
    *   Displays the selected article's outline (H1, H2s, H3s) for reference.
    *   A main content area (rich text editor preferred) where the AI-generated article text will appear.
    *   A "Generate Article Text" button.
    *   Loading indicators (Polaris `Spinner` or `ProgressBar`) while the backend processes the request.
*   **Backend Interaction (Cloud Function - e.g., `POST /api/content/construct-article`):**
    *   Receives:
        *   `articleId`: The ID of the specific article being processed (from `job_articles` collection).
        *   The approved article outline data structure (if not already reliably fetched by the backend using `articleId`).
        *   `shop_id` (from verified session token).
    *   Logic:
        1.  Fetches the article's outline from Firestore using the `articleId` if not fully passed by the client.
        2.  Constructs a detailed prompt for Gemini AI (or equivalent) as per the requirements in the original document (word count, follow outline, keywords, PAA questions, conversion focus, style guides, and the `[generated by Content Agent]` watermark).
        3.  Makes the API call to the AI text generation service.
        4.  Updates the `constructedTextHtml` (or similar field) and `status` (e.g., to `text_ready_for_review`) for the specific `articleId` in the `job_articles` Firestore collection.
        5.  Returns the full article text and its updated status to the frontend.
*   **Frontend Display:**
    *   The returned article text is displayed in the editor.
    *   User can review the text. Minor edits might be allowed.
    *   Buttons like "Proceed to Image Generation" or "Mark as Ready for Commit" become active.

## Step 6: AI Image Generation (for the Selected Article, Plan-Dependent & Optional)

*   **Purpose:** Generate relevant images for the currently selected article using AI, based on suggestions from its outline.
*   **Context:** The user is working on the same selected article (with its `articleId`), which now has AI-constructed text.
*   **UI (React/Polaris - `SingleArticleProcessor` component):**
    *   An "Image Generation" view or section.
    *   Displays the article text.
    *   Lists the AI's image suggestions from the article's outline.
    *   For each suggestion: "Generate Image Options" button, display area for options, selection mechanism.
*   **Backend Interaction (Cloud Function - e.g., `POST /api/content/generate-image`):**
    *   Receives:
        *   `articleId`: The ID of the specific article.
        *   An image suggestion/prompt.
        *   `shop_id`.
    *   Logic:
        1.  Constructs prompt for an AI image generation service.
        2.  Calls the image generation API.
        3.  Handles the returned image data (e.g., URLs from temporary storage).
        4.  Updates the `selectedImageUrls` (or similar field) and `status` for the specific `articleId` in `job_articles` upon user selection (this might involve a subsequent call if selection happens after options are displayed).
        5.  Returns image options to the frontend.
*   **Frontend Handling & Image Storage:**
    *   Displays generated image options.
    *   User selects images. Selected image URLs/references are associated with the article data on the backend (tied to the `articleId`).
    *   Long-term image storage considerations (e.g., Shopify CDN upload during commit phase, or persistent app storage) apply as per the original document.

## Workflow After Processing the Single Article

*   **Return to Workspace:** After completing text construction and/or image generation for the *current single article* (or if the user chooses to save progress and exit the `SingleArticleProcessor`), the user is typically returned to the "Article Workspace."
*   **Status Update:** In the Article Workspace, the status of the just-processed article (identified by its `articleId`) will be updated to reflect its new state (e.g., "Text Ready for Review," "Images Selected," "Ready to Commit/Export"). This status update is driven by the backend changes to the `job_articles` entry and fetched by the workspace.
*   **User Choice:** From the Article Workspace, the user can then:
    *   Select another article from the batch to process (repeating Steps 5 and 6 for that new `articleId`).
    *   Proceed to commit/export one or more articles that are in a "Ready to Commit/Export" state (as detailed in `docs/jules/shopify-app/jules.publishing-and-export.md`).

## Managing the Multi-Article Batch

The "Article Workspace" is the central hub for managing a batch of articles. The process is:
1.  Batch outline generation occurs first (covered in `jules.core-article-generation-flow.md`).
2.  The user then navigates to the Article Workspace, where all generated outlines are listed.
3.  This document (`jules.article-construction-and-imaging.md`) details the "single piece flow" for constructing text and generating images for *one article at a time*, selected by the user from the workspace.
4.  After processing each article, the user returns to the workspace to see updated statuses and choose their next action.

This modular approach (batch outline, then per-article processing via the workspace) ensures clarity and control for the user when dealing with multiple articles.
