# Content Agent Shopify App: Publishing & Export

This document covers the final stage of the "Content Agent" Shopify app's article generation workflow: committing the generated content to the Shopify store's blog, or exporting it for use on external platforms. This follows the Article Construction and Image Generation steps.

## Step 7: Commit Content & Export Options

*   **Purpose:** Allow the user to save the finalized article(s) as drafts to their Shopify blog or export them in various formats, with specific rules for external publishing to avoid duplicate content.
*   **Context:** The user has one or more fully constructed articles (text and selected images, if any). If multiple articles were generated, they might be in an "Article Review/Commit Workspace" where each can be processed.

### 7.1. UI for Committing/Exporting (React/Polaris)

*   **Article List/View:**
    *   If multiple articles were generated, display a list of these finalized articles (e.g., with their H1 titles).
    *   For each article, provide options/buttons:
        *   "Review & Commit to Shopify Blog"
        *   "Prepare for Export / Download"
*   **Review Screen (Before Committing to Shopify):**
    *   Display the full article content (including images) as it would appear.
    *   A final confirmation: "Are you sure you want to save this article as a draft to your Shopify blog?"
    *   **Metadata Note:** Inform the user that an author tag "Content Agent for Shopify, by GoodCode.ca" will be added to the blog post's metadata.
*   **Export Options Screen (If not committing to Shopify):**
    *   **Download Options (All Plans):**
        *   Button: "Download as Markdown (.md)"
        *   Button: "Download as Plain Text (.txt)"
    *   **Direct API Publishing (Paid Plans, if feature enabled for the selected external platform):**
        *   A `Select` list or `RadioButton` group: "Choose External Platform to Publish To:"
            *   Options: "WordPress", "Ghost", "Medium", "LinkedIn" (initially, WordPress will be the primary documented example for API integration).
        *   If a platform requiring authentication is selected (e.g., WordPress):
            *   If credentials for that platform are not yet stored for the shop: Display a button/link "Connect to [Platform]" which takes them to a credential input/OAuth flow for that specific platform.
            *   If credentials are stored: Display a "Publish to [Platform]" button.
        *   **Important Rule Display:** "Note: Publishing to an external platform means this article cannot also be published to your Shopify Blog via Content Agent to avoid duplicate content. You can only publish to one external platform per article."

### 7.2. Backend Logic: Committing to Shopify Blog (Cloud Function)

*   **Endpoint:** e.g., `POST /api/content/commit-to-shopify`
*   **Receives:**
    *   `shop_id` (from verified session token).
    *   `articleTitle` (String).
    *   `articleHtmlContent` (String - the full article formatted as HTML, as Shopify blogs use HTML).
    *   `author` (String - e.g., "Content Agent for Shopify, by GoodCode.ca").
    *   `tags` (Array of strings, optional - could be derived from keywords).
    *   `featuredImageUrl` (String, optional - URL of the main image if one was selected/generated. This image might need to be uploaded to Shopify's CDN first).
    *   `status: "draft"` (to always save as a draft initially).
*   **Logic:**
    1.  Uses the shop's stored Shopify access token.
    2.  **Image Handling:** If images generated by an AI service have temporary URLs, they first need to be uploaded to Shopify's CDN via the Shopify Admin API (e.g., to Files or directly to the article if the API supports it). The `articleHtmlContent` must then be updated with these new Shopify CDN URLs for the images.
    3.  Calls the Shopify Admin API to create a new blog post (`POST /admin/api/blogs/{blog_id}/articles.json`).
        *   The `blog_id` needs to be known (Shopify stores usually have a default blog, or the app could allow users to select one if multiple exist). This might be fetched and stored during app onboarding or settings.
        *   The request body includes `title`, `body_html`, `author`, `tags`, `image` (for featured image), and `published: false`.
    4.  Stores a record in Firestore indicating this article has been committed to Shopify to prevent duplicate external publishing (e.g., in an `articles` collection associated with the `shop_id`).
*   **Response:** Success message, perhaps with a link to the newly created draft blog post in the Shopify admin.

### 7.3. Backend Logic: Downloadable Formats (Cloud Function)

*   **Endpoint:** e.g., `POST /api/content/download-article`
*   **Receives:**
    *   `shop_id`.
    *   `articleTitle`, `articleHtmlContent` (or Markdown if AI generates that first).
    *   `format`: "markdown" or "plaintext".
*   **Logic:**
    1.  If `articleHtmlContent` is provided and Markdown is requested, use a library (e.g., `turndown` for Node.js) to convert HTML to Markdown.
    2.  If plain text is requested, strip HTML tags from `articleHtmlContent`.
    3.  Set appropriate `Content-Disposition` and `Content-Type` headers for file download.
*   **Response:** The file content.

### 7.4. Backend Logic: API Publishing to External Platforms (Paid Plans)

This section will initially focus on **WordPress** as the primary documented example.

*   **Prerequisite:** User must have authenticated their WordPress site with the app, and the app must have securely stored the WordPress site URL and API credentials (e.g., Application Password, encrypted in Firestore under `shops/{shop_id}/credentials/wordpress_api`).
*   **Endpoint:** e.g., `POST /api/content/publish-to-wordpress`
*   **Receives:**
    *   `shop_id`.
    *   `articleTitle`, `articleHtmlContent` (WordPress can take HTML).
    *   `status` (e.g., "draft", "publish" - configurable by user in UI).
    *   `categories`, `tags` (optional).
*   **Logic:**
    1.  Retrieve the shop's stored WordPress credentials and decrypt them.
    2.  Use the WordPress REST API (typically by making HTTP requests with `axios` or similar, authenticated with the Application Password) to create a new post.
        *   Endpoint: `https://<user_wordpress_url>/wp-json/wp/v2/posts`
        *   Body: `{ title, content, status, categories, tags }`
    3.  **Image Handling:** If images need to be uploaded to the WordPress media library first, this involves additional WordPress API calls to upload images and then embedding the returned WordPress image URLs into the content.
    4.  Store a record in Firestore indicating this article has been published to WordPress (and its WordPress post ID) to prevent duplicate external publishing or committing to Shopify.
*   **Response:** Success/failure message, perhaps with a link to the new WordPress post.

**General Considerations for External Publishing:**
*   **Credential Management:** Each external platform (Ghost, Medium, LinkedIn) will have its own authentication method (OAuth, API keys). The app will need UI flows and backend logic to manage these credentials securely for each platform a user wants to connect.
*   **API Differences:** Each platform has a different API for publishing content. The backend will need separate modules/logic for each.
*   **Content Formatting:** While HTML is common, some platforms might prefer Markdown or have specific nuances.

### 7.5. Tracking Published State
*   It's crucial to maintain a state in Firestore for each generated article, indicating:
    *   Its internal ID.
    *   `shop_id`.
    *   Whether it was committed to Shopify (and Shopify blog post ID).
    *   Or, if published externally, to which platform (e.g., `externalPlatform: "wordpress"`, `externalPostId: "123"`).
*   This prevents users from accidentally publishing the same content to multiple public places via the app. The UI should reflect this state (e.g., "Published to Shopify Blog," "Published to WordPress," "Ready to Export/Publish").

This step concludes the primary content generation and output flow. Users can now see their generated content live (or as a draft) in their chosen location.
